<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Shipping Calculator</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.full.min.js"></script>
    <stylesrc='style.css' ></stylesrc></style>
</head>
<body>
    <h2>Shipping Calculator</h2>
    <input type="text" id="invoiceTitle" placeholder="Invoice Title">
    <button onclick="addBox()">Add Box</button>
    <button onclick="exportToExcel()">Export to Excel</button>
    <button onclick="clearData()">Clear All</button>

    <table id="boxTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Length (cm)</th>
                <th>Width (cm)</th>
                <th>Height (cm)</th>
                <th>Weight (kg)</th>
                <th>Volume (mÂ³)</th>
                <th>Air Cost</th>
                <th>Sea Cost</th>
                <th>Land Cost</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr>
                <td colspan="6"><strong>Totals</strong></td>
                <td id="totalAir">0</td>
                <td id="totalSea">0</td>
                <td id="totalLand">0</td>
            </tr>
            <tr>
                <td colspan="8"><strong>Total Gross Weight:</strong></td>
                <td id="totalWeight">0</td>
            </tr>
        </tfoot>
    </table>

    <script>
        let boxData = [];

        function addBox() {
            boxData.push({ length: 0, width: 0, height: 0, weight: 0, volume: 0, airCost: 0, seaCost: 0, landCost: 0 });
            updateTable();
        }

        function editBox(index, field, value) {
            const num = parseFloat(value);
            if (!isNaN(num)) {
                boxData[index][field] = num;
                const { length, width, height, weight } = boxData[index];
                const volume = (length * width * height) / 1e6;
                boxData[index].volume = volume;
                boxData[index].airCost = (length * width * height) / 6000;
                boxData[index].seaCost = (length * width * height) / 5000;
                boxData[index].landCost = (length * width * height) / 4000;
                updateTable();
            }
        }

        function updateTable() {
            const tableBody = document.getElementById("boxTable").querySelector("tbody");
            tableBody.innerHTML = "";
            let totalAir = 0, totalSea = 0, totalLand = 0, totalWeight = 0;
            boxData.forEach((box, i) => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td contenteditable oninput="editBox(${i}, 'length', this.innerText)">${box.length}</td>
                    <td contenteditable oninput="editBox(${i}, 'width', this.innerText)">${box.width}</td>
                    <td contenteditable oninput="editBox(${i}, 'height', this.innerText)">${box.height}</td>
                    <td contenteditable oninput="editBox(${i}, 'weight', this.innerText)">${box.weight}</td>
                    <td>${box.volume.toFixed(2)}</td>
                    <td>${box.airCost.toFixed(2)}</td>
                    <td>${box.seaCost.toFixed(2)}</td>
                    <td>${box.landCost.toFixed(2)}</td>
                `;
                totalAir += box.airCost;
                totalSea += box.seaCost;
                totalLand += box.landCost;
                totalWeight += box.weight;
            });
            document.getElementById("totalAir").textContent = totalAir.toFixed(2);
            document.getElementById("totalSea").textContent = totalSea.toFixed(2);
            document.getElementById("totalLand").textContent = totalLand.toFixed(2);
            document.getElementById("totalWeight").textContent = totalWeight.toFixed(2);
            saveData();
        }

        function saveData() {
            fetch('/data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(boxData)
            });
        }

        function loadData() {
            fetch('/data')
                .then(res => res.json())
                .then(data => {
                    boxData = data;
                    updateTable();
                });
        }

        function clearData() {
            fetch('/reset', { method: 'POST' })
                .then(() => {
                    boxData = [];
                    document.getElementById("invoiceTitle").value = "";
                    updateTable();
                });
        }

        function exportToExcel() {
            const title = document.getElementById("invoiceTitle").value.trim();
            if (!boxData.length || !title) {
                alert("Please enter invoice title and add at least one box");
                return;
            }
            const table = document.getElementById("boxTable");
            const workbook = XLSX.utils.table_to_book(table, { sheet: "Boxes" });
            const summary = [
                ['Total Air', document.getElementById("totalAir").textContent],
                ['Total Sea', document.getElementById("totalSea").textContent],
                ['Total Land', document.getElementById("totalLand").textContent],
                ['Total Gross Weight', document.getElementById("totalWeight").textContent + " kg"]
            ];
            const summarySheet = XLSX.utils.aoa_to_sheet(summary);
            XLSX.utils.book_append_sheet(workbook, summarySheet, "Summary");
            XLSX.writeFile(workbook, `${title.replace(/\s+/g, "_")}.xlsx`);
        }

        window.onload = loadData;
    </script>
</body>
</html>